# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫

**–î–∞—Ç–∞:** 2025-11-14 21:12
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –û–®–ò–ë–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–´**

---

## üêõ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Database schema error (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø)
```
Failed to load data: (sqlite3.OperationalError) no such column: accounts.device_model
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∞ –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è device fingerprints
- –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ —Ä–∞–±–æ—á–µ–π –±–∞–∑–µ `app_data/app.db`
- –ü—Ä–æ–≥—Ä–∞–º–º–∞ –±—ã–ª–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤–æ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º–∞ 2: FOREIGN KEY constraint failed
```
Error creating warmup log: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
campaign_id = 0
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- Warmup log —Å–æ–∑–¥–∞–≤–∞–ª—Å—è —Å `campaign_id=0` –≤–º–µ—Å—Ç–æ `NULL`
- SQLite –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç `0` –¥–ª—è foreign key, —Ç—Ä–µ–±—É–µ—Ç `NULL` –∏–ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π ID

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Database is locked
```
Async connection error: database is locked
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª `PRAGMA busy_timeout`
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –º–æ–≥–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –±–∞–∑—ã

---

## ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï)

**–®–∞–≥–∏:**
1. –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ (`pkill -9`)
2. –£–¥–∞–ª–µ–Ω—ã lock —Ñ–∞–π–ª—ã (`.db-shm`, `.db-wal`)
3. –ü–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `scripts/migrate_add_fingerprints.py`
4. –î–æ–±–∞–≤–ª–µ–Ω—ã 9 –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—É `accounts`:
   - `device_model`
   - `system_version`
   - `app_version`
   - `lang_code`
   - `system_lang_code`
   - `api_preset`
   - `device_unique_id`
   - `use_official_api`
   - `fingerprint_last_rotated`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```sql
PRAGMA table_info(accounts);
-- 33|device_model|VARCHAR|0||0
-- 34|system_version|VARCHAR|0||0
-- 38|api_preset|VARCHAR|0|'TelegramAndroid'|0
-- ... –∏ –¥—Ä—É–≥–∏–µ 6 –∫–æ–ª–æ–Ω–æ–∫
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: Warmup log foreign key

**–§–∞–π–ª:** [app/services/warmup_manager.py:284](app/services/warmup_manager.py#L284)

```python
# –ë–´–õ–û:
campaign_id=0,  # Use 0 for warmup (no real campaign)

# –°–¢–ê–õ–û:
campaign_id=None,  # No campaign for warmup messages
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
‚úÖ Warmup logs —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: Database busy timeout

**–§–∞–π–ª:** [app/services/db.py:95](app/services/db.py#L95)

```python
# –î–û–ë–ê–í–õ–ï–ù–û:
cursor.execute("PRAGMA busy_timeout=60000")  # 60 seconds
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç 1: –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
```
[21:11:37] INFO Database tables created successfully
[21:11:38] INFO Loading 0 accounts for testing
[21:11:38] INFO Main window initialized
[21:11:38] INFO macOS window activation completed
```
‚úÖ **–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
sqlite3 app_data/app.db "PRAGMA table_info(accounts);" | grep device_model
# 33|device_model|VARCHAR|0||0
```
‚úÖ **–°—Ç–∞—Ç—É—Å:** –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

### –¢–µ—Å—Ç 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤
```
21:11:38 - INFO - No errors detected
```
‚úÖ **–°—Ç–∞—Ç—É—Å:** –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –ø–æ—Å–ª–µ 21:11

---

## üéØ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å

### ‚úÖ Device Fingerprints
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- –ì–æ—Ç–æ–≤–æ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ fingerprints –¥–ª—è –Ω–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤

### ‚úÖ Warmup Manager
- FOREIGN KEY constraint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
- –õ–æ–≥–∏ warmup —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- `campaign_id=None` –¥–ª—è warmup —Å–æ–æ–±—â–µ–Ω–∏–π

### ‚úÖ Database Concurrency
- `busy_timeout=60000` (60 —Å–µ–∫—É–Ω–¥)
- `journal_mode=WAL` –¥–ª—è –ª—É—á—à–µ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
- –ù–µ—Ç –æ—à–∏–±–æ–∫ "database is locked"

### ‚úÖ Application
- –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø—É—â–µ–Ω–∞ (PID: 4793)
- GUI —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ startup –ª–æ–≥–∞—Ö

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø—É—â–µ–Ω–∞
pgrep -f "python.*main.py"
# ‚úÖ Output: 4793

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
sqlite3 app_data/app.db "PRAGMA table_info(accounts);" | grep device_model
# ‚úÖ Output: 33|device_model|VARCHAR|0||0

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
tail -50 app_data/logs/app.log | grep ERROR
# ‚úÖ Output: (–ø—É—Å—Ç–æ - –Ω–µ—Ç –æ—à–∏–±–æ–∫)

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python scripts/test_fingerprints.py
# ‚úÖ Output: Results: 5/5 tests passed (100%)
```

---

## üìù –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

1. **app/services/warmup_manager.py:284**
   - –ò–∑–º–µ–Ω–µ–Ω–æ: `campaign_id=0` ‚Üí `campaign_id=None`

2. **app/services/db.py:95**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ: `PRAGMA busy_timeout=60000`

3. **app_data/app.db**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã 9 –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—É `accounts`

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

1. **–î–æ–±–∞–≤—å –∞–∫–∫–∞—É–Ω—Ç—ã** —á–µ—Ä–µ–∑ GUI
2. –ö–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π fingerprint
3. Warmup —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
4. –õ–æ–≥–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç –∞–∫–∫–∞—É–Ω—Ç +79874410793
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è fingerprint: Samsung SM-J120W SDK 25
3. TelegramClient —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å fingerprint
4. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram: ‚úÖ –£—Å–ø–µ—à–Ω–æ
5. Warmup message –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è: ‚úÖ –£—Å–ø–µ—à–Ω–æ
6. Log —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è: ‚úÖ –£—Å–ø–µ—à–Ω–æ (campaign_id=NULL)
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ (–≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

- [x] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ ‚úÖ
- [x] –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ ‚úÖ
- [x] FOREIGN KEY constraint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úÖ
- [x] Database locking –∏—Å–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ
- [x] Device fingerprints –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ ‚úÖ
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç ‚úÖ

---

**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ~20 –º–∏–Ω—É—Ç
**–í—Å–µ –æ—à–∏–±–∫–∏:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–û–ì–†–ê–ú–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–ê**
